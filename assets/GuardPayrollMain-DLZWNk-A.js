import{r as m,j as e,b as H,R as Y}from"./index-DwUU5yaf.js";import{h as _,P as B}from"./html2canvas.esm-BFDu3crR.js";const F=({filterMonth:n,filterPeriod:i,filterGuard:y,refreshTrigger:w})=>{const[p,f]=m.useState([]),[l,h]=m.useState([]),[j,N]=m.useState(!0),v=async()=>{N(!0);try{const a=await H.getGuardTimeRecords(500);Array.isArray(a)?f(a):(console.error("API did not return an array:",a),f([]))}catch(a){console.error("Failed to fetch records",a),f([])}finally{N(!1)}};return m.useEffect(()=>{v()},[w]),m.useEffect(()=>{if(!n)return;let a=p;a=a.filter(c=>c.timestamp?c.timestamp.startsWith(n):!1),i!=="ALL"&&(a=a.filter(c=>{const r=new Date(c.timestamp).getDate();return i==="1"?r>=1&&r<=15:i==="2"?r>=16:!0})),y!=="ALL"&&(a=a.filter(c=>c.guardName===y)),h(a)},[p,n,i,y]),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"บันทึกเวลาล่าสุด"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"วัน-เวลา"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ชื่อ รปภ."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"เหตุการณ์"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"สถานะ"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:j?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-6 py-4 text-center text-sm text-gray-500",children:"กำลังโหลดข้อมูล..."})}):l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-6 py-4 text-center text-sm text-gray-500",children:"ไม่พบข้อมูลตามเงื่อนไขที่เลือก"})}):l.map((a,c)=>{const T=new Date(a.timestamp).toLocaleDateString("th-TH",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:T}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium",children:a.guardName}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                ${a.eventType.includes("เข้างาน")||a.eventType.includes("Check-in")?"bg-green-100 text-green-800":a.eventType.includes("เลิกงาน")||a.eventType.includes("Check-out")?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:a.eventType})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:a.status})]},a.rowIndex||c)})})]})})]})},I=n=>{const i=new Date(n);return new Date(i.getTime()+420*60*1e3)},P=n=>I(n).toISOString().split("T")[0],$=n=>I(n).getUTCHours(),G=420,z=15,U=30,M=G/12;function q(n,i,y){const w=n.filter(l=>{const h=P(l.timestamp);return h>=i&&h<=y}),p={};w.forEach(l=>{p[l.guardName]||(p[l.guardName]={});const h=P(l.timestamp);p[l.guardName][h]||(p[l.guardName][h]=[]),p[l.guardName][h].push(l)});const f=[];return Object.keys(p).forEach(l=>{const h=p[l],j=[];let N=0,v=0,a=0,c=0;const r=new Date(i),T=new Date(y);for(;r<=T;){const s=r.toISOString().split("T")[0],S=r.getDay()!==0,u=h[s]||[];if(u.length===0){let o="",x=!1;S?(o="ขาดงาน",x=!0):(o="วันหยุด",x=!1),j.push({date:s,guardName:l,isLate:!1,lateMinutes:0,isAbsent:x,totalWorkHours:0,wage:0,deduction:0,netWage:0,note:o}),x&&v++}else{u.sort((d,A)=>{const E=new Date(d.timestamp).getTime(),C=new Date(A.timestamp).getTime();return E!==C?E-C:(d.rowIndex||0)-(A.rowIndex||0)});let o=u.find(d=>d.eventType.includes("เข้า")||d.eventType.includes("Check-in"));if(!o&&u.length>0){const d=u[0];$(d.timestamp)<12&&(o=d)}let x=[...u].reverse().find(d=>d.eventType.includes("เลิก")||d.eventType.includes("Check-out"));if(!x&&u.length>0){const d=u[u.length-1],A=d.eventType.includes("เข้า")||d.eventType.includes("Check-in");$(d.timestamp)>=12&&!A&&(x=d)}o&&x&&o.rowIndex===x.rowIndex&&($(o.timestamp)>=12?o=void 0:x=void 0);let L=null,R=!1,D=0,k=0;if(o){const d=I(o.timestamp),A=d.getUTCHours(),E=d.getUTCMinutes(),C=390,W=A*60+E;W>C&&(D=W-C,D>U?(R=!0,k=M*1):D>z&&(R=!0,k=M*.5)),L=o.timestamp}const O=G;j.push({date:s,guardName:l,checkIn:L||void 0,checkOut:x?.timestamp,isLate:R,lateMinutes:D,isAbsent:!1,totalWorkHours:12,wage:O,deduction:k,netWage:O-k,note:""}),R&&N++,a+=O,c+=k}r.setDate(r.getDate()+1)}const t=N===0&&v===0,b=0;f.push({guardName:l,totalDays:j.filter(s=>!s.isAbsent).length,totalLateDays:N,totalAbsentDays:v,totalWage:a,totalDeduction:c,diligenceBonus:b,netPayable:a-c+b,details:j})}),f}const J=m.forwardRef(({filterMonth:n,filterPeriod:i,filterGuard:y,refreshTrigger:w},p)=>{const[f,l]=m.useState([]),[h,j]=m.useState([]),[N,v]=m.useState(!1),a=async()=>{v(!0);try{const t=await H.getGuardTimeRecords(500);Array.isArray(t)?l(t):(console.error("API did not return an array:",t),l([]))}catch(t){console.error(t),l([])}finally{v(!1)}};m.useEffect(()=>{a()},[w]),m.useEffect(()=>{if(f.length===0||!n)return;const[t,b]=n.split("-").map(Number);let s=1,g=new Date(t,b,0).getDate();i==="1"?g=15:i==="2"&&(s=16);const S=`${t}-${String(b).padStart(2,"0")}-${String(s).padStart(2,"0")}`,u=`${t}-${String(b).padStart(2,"0")}-${String(g).padStart(2,"0")}`,o=q(f,S,u);let x=o;y!=="ALL"&&(x=o.filter(L=>L.guardName===y)),j(x)},[f,n,i,y]);const c=m.useMemo(()=>{const t=new Intl.NumberFormat("th-TH",{style:"currency",currency:"THB"});return b=>t.format(b)},[]),r=Y.useRef(null),T=async()=>{if(!r.current)return;const t=r.current;let b="";b=t.style.minWidth,t.style.minWidth="1200px";const[s,g]=n.split("-").map(Number),u=new Date(s,g-1).toLocaleDateString("th-TH",{month:"long",year:"numeric"});let o="ทั้งเดือน";i==="1"&&(o="งวดที่ 1 (1-15)"),i==="2"&&(o="งวดที่ 2 (16-สิ้นเดือน)");const x=document.createElement("div");x.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: bold; color: #1e293b; margin: 0;">รายงานสรุปค่าจ้าง รปภ.</h2>
                    <p style="font-size: 16px; color: #64748b; margin: 5px 0 0 0;">ประจำเดือน: <span style="color: #0f172a; font-weight: 600;">${u}</span> | งวด: <span style="color: #0f172a; font-weight: 600;">${o}</span></p>
                </div>
                <div style="text-align: right;">
                     <p style="font-size: 12px; color: #94a3b8; margin: 0;">วันที่พิมพ์รายงาน</p>
                     <p style="font-size: 14px; font-weight: 600; color: #475569; margin: 0;">${new Date().toLocaleString("th-TH")}</p>
                </div>
            </div>
        `,t.insertBefore(x,t.firstChild);try{const R=(await _(t,{scale:2,backgroundColor:"#ffffff",windowWidth:1400})).toDataURL("image/png"),D=document.createElement("a");D.href=R,D.download=`payroll-report-${n}-${i}.png`,D.click()}catch(L){console.error("Print failed",L)}finally{x.parentNode===t&&t.removeChild(x),t.style.minWidth=b}};return m.useImperativeHandle(p,()=>({print:T})),e.jsx("div",{ref:r,className:"space-y-6 relative p-2",children:N?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-500",children:"กำลังดึงข้อมูล..."})]}):h.length===0?e.jsx("div",{className:"text-center py-10 bg-white rounded-lg border border-dashed border-gray-300",children:e.jsx("p",{className:"text-gray-500",children:"ไม่พบข้อมูลในช่วงเวลาที่เลือก"})}):e.jsx("div",{className:"grid gap-6",children:h.map((t,b)=>e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:t.guardName}),e.jsxs("p",{className:"text-sm text-gray-500",children:["รวมทำงาน ",t.totalDays," วัน | สาย ",t.totalLateDays," วัน | ขาด ",t.totalAbsentDays," วัน"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase",children:"รายรับสุทธิ"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:c(t.netPayable)})]})]}),e.jsxs("div",{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 border-b border-gray-100",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ค่าจ้างรวม"}),e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:c(t.totalWage)})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"หักสาย/ขาด"}),e.jsxs("p",{className:"text-lg font-semibold text-red-600",children:["-",c(t.totalDeduction)]})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"เบี้ยขยัน"}),e.jsxs("p",{className:"text-lg font-semibold text-yellow-700",children:["+",c(t.diligenceBonus)]}),e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:t.totalLateDays===0&&t.totalAbsentDays===0?"เข้าเกณฑ์":"ไม่ผ่านเกณฑ์"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"สุทธิ"}),e.jsx("p",{className:"text-lg font-bold text-green-700",children:c(t.netPayable)})]})]}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"รายละเอียดรายวัน"}),e.jsx("div",{className:"overflow-x-auto border rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"วันที่"}),e.jsx("th",{className:"px-4 py-2 text-center text-xs font-medium text-gray-500",children:"เข้า"}),e.jsx("th",{className:"px-4 py-2 text-center text-xs font-medium text-gray-500",children:"ออก"}),e.jsx("th",{className:"px-4 py-2 text-center text-xs font-medium text-gray-500",children:"สาย (นาที)"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500",children:"ค่าแรง"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500",children:"หัก"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500",children:"สุทธิ"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"หมายเหตุ"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:t.details.filter(s=>{const g=new Date,S=`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}`;if(n===S){const u=`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}-${String(g.getDate()).padStart(2,"0")}`;return s.date<=u}return!0}).map((s,g)=>e.jsxs("tr",{className:s.note==="วันหยุด"?"bg-green-50":s.isAbsent?"bg-red-50":"",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:s.date}),e.jsx("td",{className:"px-4 py-2 text-center text-sm text-gray-500",children:s.checkIn?new Date(s.checkIn).toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"}):"-"}),e.jsx("td",{className:"px-4 py-2 text-center text-sm text-gray-500",children:s.checkOut?new Date(s.checkOut).toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"}):"-"}),e.jsx("td",{className:`px-4 py-2 text-center text-sm ${s.isLate?"text-red-600 font-bold":"text-gray-500"}`,children:s.lateMinutes>0?s.lateMinutes:"-"}),e.jsx("td",{className:"px-4 py-2 text-right text-sm text-gray-900",children:s.wage}),e.jsx("td",{className:"px-4 py-2 text-right text-sm text-red-600",children:s.deduction>0?-s.deduction:"-"}),e.jsx("td",{className:"px-4 py-2 text-right text-sm font-medium text-gray-900",children:s.netWage}),e.jsx("td",{className:"px-4 py-2 text-left text-sm text-gray-600",children:s.note&&e.jsx("span",{className:s.note==="ขาดงาน"?"text-red-600 font-semibold":s.note==="วันหยุด"?"text-green-600 font-semibold":"",children:s.note})})]},g))})]})})]})]},b))})})}),V=()=>{const[n,i]=m.useState("RECORDS"),y=Y.useRef(null),[w,p]=m.useState(""),[f,l]=m.useState("ALL"),[h,j]=m.useState("ALL"),[N,v]=m.useState([]);m.useEffect(()=>{const r=new Date,T=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0");p(`${T}-${t}`),(async()=>{try{const s=await H.getGuardTimeRecords(500);if(Array.isArray(s)){const g=Array.from(new Set(s.map(S=>S.guardName))).filter(Boolean).sort();v(g)}}catch(s){console.error("Failed to fetch guard list",s)}})()},[]);const a=0,c=()=>{y.current&&y.current.print()};return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 animate-in fade-in duration-500",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"รายงานบันทึกเวลา และค่าจ้าง รปภ."}),e.jsx("p",{className:"mt-2 text-gray-600",children:"จัดการเวลาเข้า-ออก และคำนวณเงินเดือนเจ้าหน้าที่รักษาความปลอดภัย"})]}),e.jsx("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-center justify-between",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"รปภ."}),e.jsxs("select",{value:h,onChange:r=>j(r.target.value),className:"border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]",children:[e.jsx("option",{value:"ALL",children:"ทุกท่าน"}),N.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"เดือน"}),e.jsx("input",{type:"month",value:w,onChange:r=>p(r.target.value),className:"border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"งวด"}),e.jsxs("select",{value:f,onChange:r=>l(r.target.value),className:"border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"ALL",children:"ทั้งเดือน"}),e.jsx("option",{value:"1",children:"งวดที่ 1 (1-15)"}),e.jsx("option",{value:"2",children:"งวดที่ 2 (16-สิ้นเดือน)"})]})]})]})}),e.jsxs("div",{className:"border-b border-gray-200 mb-6 flex justify-between items-end",children:[e.jsxs("nav",{className:"-mb-px flex space-x-8",children:[e.jsx("button",{onClick:()=>i("RECORDS"),className:`
                            whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors
                            ${n==="RECORDS"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
                        `,children:"ตารางบันทึกเวลา"}),e.jsx("button",{onClick:()=>i("PAYROLL"),className:`
                            whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors
                            ${n==="PAYROLL"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
                        `,children:"การคำนวณค่าจ้าง"})]}),n==="PAYROLL"&&e.jsxs("button",{onClick:c,className:"mb-2 flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm font-bold text-sm",children:[e.jsx(B,{size:16}),e.jsx("span",{children:"พิมพ์รายงาน"})]})]}),e.jsxs("div",{children:[n==="RECORDS"&&e.jsx(F,{filterMonth:w,filterPeriod:f,filterGuard:h,refreshTrigger:a}),n==="PAYROLL"&&e.jsx(J,{ref:y,filterMonth:w,filterPeriod:f,filterGuard:h,refreshTrigger:a})]})]})};export{V as GuardPayrollMain};
